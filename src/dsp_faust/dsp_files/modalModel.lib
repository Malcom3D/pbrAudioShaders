import("dsp_files/faustlib/stdfaust.lib");

modalModel(exPos,t60,t60DecayRatio,t60DecaySlope) = _ <: par(i,nModes,pm.modeFilter(modesFreqs(i),modesT60s(i),modesGains(int(exPos),i))) :> /(nModes)
with{
nModes = 20;
nExPos = 42;
modesFreqs(n) = ba.take(n+1,(1525,1532.65,1541.94,1547.41,1572.76,1952.06,2115.01,2197.95,2361.55,2562.01,2822.75,3009.35,3139.71,3179.07,3196.7,3244.84,3474.53,3553.56,3621.19,3673.55));
modesGains(p,n) = waveform{0.661207,0.456534,0.457538,0.689991,0.743295,0.412162,0.422693,0.649535,0.578628,0.410484,0.64994,0.586876,0.691606,0.361462,0.419911,0.464603,1,0.612442,0.678808,0.729042,0.730871,0.498291,0.538825,0.808361,0.876084,0.39184,0.408992,0.476839,0.318792,0.253734,0.819538,0.675317,0.938263,0.586747,0.258026,0.47221,1,0.886475,0.837147,0.574119,0.316243,0.532995,0.419298,0.26081,0.378394,0.471074,0.526178,0.788951,1,0.828211,0.308437,0.48302,0.643133,0.798452,0.531986,0.444769,0.590374,0.567824,0.333154,0.922606,0.316383,0.507769,0.235592,0.426736,0.510897,0.75525,0.585217,0.411859,0.745912,0.833026,0.455816,0.589402,0.422495,0.515494,0.461301,1,0.560937,0.303837,0.207617,0.710602,0.354654,0.525837,0.260845,0.451919,0.536687,0.849488,0.645495,0.334654,0.852754,1,0.542828,0.615394,0.301121,0.552356,0.87768,0.739805,0.200519,0.575832,0.221187,0.736966,0.275467,0.596272,0.478479,0.552109,0.311808,1,0.815327,0.427137,0.457557,0.600321,0.371673,0.76619,0.48554,0.423886,0.10832,0.623431,0.468226,0.201062,0.221517,0.615672,0.408043,0.402246,0.362829,0.598145,0.436881,0.452349,0.299336,0.425943,0.533736,0.192472,1,0.524396,0.793674,0.66531,0.179558,0.555593,0.818548,0.44685,0.757269,0.58372,0.286431,0.591173,0.486607,0.544164,0.322792,1,0.874785,0.288379,0.416147,0.59816,0.33123,0.772942,0.31609,0.449274,0.502051,0.513879,0.183928,0.625457,0.229369,0.638255,0.314226,0.342375,0.46483,0.174883,0.151574,0.144828,0.551478,0.73408,0.433946,0.1191,0.651466,0.564833,0.787967,0.251109,0.15865,1,0.998644,0.952599,0.38114,0.584674,0.591124,0.239576,0.466137,0.26107,0.556148,0.63049,0.517923,0.447914,0.352904,0.408081,0.596709,0.55209,0.152125,1,0.629921,0.666797,0.544579,0.998644,0.844518,0.170814,0.439976,0.433793,0.382523,0.629283,0.455296,0.50088,0.281308,0.409337,0.567934,0.27092,0.984485,0.519584,1,0.35235,0.885689,0.237386,0.575746,0.697456,0.797657,0.572155,0.279278,0.291264,0.447696,0.156592,0.133759,0.0494636,0.619298,1,0.567065,0.311759,0.540034,0.609431,0.738036,0.69737,0.653385,0.829444,0.792904,0.54532,0.333897,0.538341,0.990983,0.205244,0.731744,0.472699,0.817935,0.43806,0.52487,0.292461,0.828564,0.95502,0.640161,0.456532,0.369826,0.363512,0.728517,0.131628,0.269112,0.607668,0.69599,1,0.5816,0.34467,0.656828,0.291828,0.344324,0.424881,0.679368,0.982125,0.373631,0.305347,1,0.600985,0.820781,0.604811,0.967174,0.625888,0.529174,0.578037,0.711869,0.510581,0.589525,0.34415,0.507536,0.0241499,0.412951,0.408487,0.515496,0.697492,0.628686,0.594492,0.418209,0.565276,0.932001,0.671209,0.562776,0.600486,0.833564,0.516319,1,0.726811,0.234138,0.399576,0.545332,0.335467,0.12841,0.645978,1,0.610499,0.248985,0.29031,0.475157,0.683079,0.51282,0.549521,0.571571,0.400655,0.530227,0.5574,0.30003,0.900965,0.39012,0.686817,0.490919,0.649977,0.423885,0.974935,0.523446,0.512278,0.538403,0.777321,0.779032,0.797784,0.708541,0.422533,0.271567,0.629652,1,0.606856,0.752363,0.429112,0.603532,0.362714,0.481249,0.624254,1,0.63686,0.685833,0.55966,0.60182,0.367623,0.830871,0.48399,0.53649,0.897225,0.17016,0.256179,0.247993,0.230892,0.114121,0.846142,0.793581,0.398453,0.699859,0.797289,0.838149,0.436883,0.249504,0.44464,0.539688,0.368948,0.632635,0.67846,0.60252,0.574169,0.488354,0.905119,0.92833,1,0.809087,0.36294,0.40685,0.53024,0.196491,0.618156,0.599228,0.236186,0.406337,0.459024,0.323891,0.530829,0.332215,0.391183,0.592918,0.361345,0.412253,0.29264,0.47897,0.864117,1,0.33329,0.442387,0.570313,0.350435,0.564252,0.537747,0.421462,0.329901,0.635065,0.661334,0.179461,1,0.527455,0.554786,0.837424,0.383154,0.356667,0.427903,0.36343,0.601155,0.805288,0.332068,0.515945,0.358168,0.55919,0.521671,0.283947,0.412157,0.534103,0.720874,1,0.257039,0.483882,0.433954,0.461815,0.431703,0.337314,0.384808,0.585633,0.107418,0.143527,0.270696,0.357783,0.427577,0.390791,0.196275,0.324691,0.645449,1,0.604783,0.167057,0.443973,0.578683,0.457424,0.473752,0.409009,0.723523,0.673448,0.0850953,0.359654,0.258608,0.334802,0.49228,0.417763,0.610918,0.2362,1,0.743114,0.27333,0.443925,0.531219,0.441067,0.676415,0.79275,0.43877,0.497416,0.514463,0.463637,0.445459,0.48239,0.291151,0.267673,0.287237,0.24715,0.168601,0.351185,0.515821,0.35904,0.34432,0.510189,0.591091,0.364995,0.466076,0.476678,0.409944,0.481482,1,0.730925,0.28577,0.547978,0.602758,0.532224,0.218845,0.418108,0.233667,0.502539,0.527273,0.465597,0.561396,0.300936,0.275077,0.508482,0.496251,0.521304,0.475807,0.52539,1,0.78878,0.392029,0.795571,0.271083,0.341748,0.491337,0.42645,0.617177,0.262665,1,0.80537,0.206099,0.406784,0.493069,0.544392,0.708856,0.614026,0.362832,0.25762,0.671825,0.68446,0.568948,0.521589,0.271455,0.471114,0.584846,0.660998,0.560874,0.672688,0.496859,0.625683,0.811504,0.589273,0.583993,0.809617,0.496206,0.420442,0.206167,0.99594,0.739981,0.893103,0.475092,1,0.430232,0.349209,0.541659,0.424436,0.253306,0.369888,0.407488,0.436462,0.575904,0.870713,0.674374,0.362099,0.437184,0.578494,0.176375,0.645813,0.521249,1,0.752855,0.351555,0.954455,0.357979,0.479951,0.536428,0.495031,0.231418,0.466869,0.737484,0.996196,0.651775,0.116438,0.51819,0.659504,0.761494,0.679012,0.168419,1,0.499403,0.926027,0.458126,0.296796,0.425693,0.59273,0.644273,0.567093,0.640427,0.486016,0.58198,0.814722,0.621271,0.592517,0.769396,0.482133,0.387808,0.903812,0.540773,0.414,0.3849,1,0.932461,0.511683,0.333034,0.334828,0.302208,0.200174,0.423252,0.653965,0.451619,0.293162,0.65663,0.804665,0.480085,0.569953,0.234638,0.862325,0.847638,0.648594,0.362144,1,0.617352,0.632792,0.43378,0.572657,0.342414,0.566815,0.556036,0.428995,0.326672,0.648718,0.64846,0.168142,1,0.534878,0.630222,0.377989,0.804924,0.241275,0.397012,0.471789,0.616705,0.91214,0.354846,0.556457,0.375013,0.574547,0.542235,0.277008,0.46958,0.543284,0.693352,1,0.281755,0.495658,0.529442,0.336794,0.690867,0.394627,0.419288,0.535199,0.0986222,0.251536,0.257637,0.465521,0.585499,0.367822,0.122885,0.755181,1,0.462951,0.137144,0.30601,0.612663,0.698968,0.542181,0.268,0.2887,0.613476,0.819796,0.5024,0.347778,0.942923,0.606908,0.361197,0.512423,0.026336,0.427634,0.366926,0.468895,0.591314,0.524876,0.478352,0.490387,0.53847,0.922895,0.292175,0.491623,0.801986,0.985147,0.999732,1,0.737983,0.825109,0.457741,0.739735,0.851615,0.859635,0.489932,0.290025,0.546546,0.594119,0.458316,0.656012,0.693428,0.709726,0.435965,0.923684,0.66209,0.765226,1,0.869337,0.150085,0.401853,0.537321,0.195651,0.612807,0.598587,0.193609,0.3752,0.51498,0.297466,0.477476,0.318241,0.402908,0.700439,0.383093,0.317226,0.137998,0.795517,0.499259,1,0.275813,0.618124,0.352818,0.475189,0.614355,1,0.606389,0.655483,0.500419,0.559472,0.373035,0.819029,0.473076,0.658038,0.162442,0.774963,0.370857,0.31745,0.217081,0.114024,0.879764,0.363782,0.654434,0.463951,0.618743,0.388915,1,0.610835,0.384115,0.391061,0.608309,0.651749,0.724486,0.60382,0.643869,0.336551,0.605451,0.3495,0.869546,0.757061,0.654976,0.522268,0.362758,0.568196,0.272632,0.323345,0.51609,0.49617,0.407857,0.413614,0.315492,1,0.502798,0.555998,0.485719,0.0992833,0.488562,0.449207,0.386573,0.648485,0.307048,1,0.194113,0.740229,0.485208,0.829542,0.45262,0.51181,0.32707,0.835157,0.950728,0.612399,0.45854,0.403135,0.773596,0.310243,0.303568,0.620464,0.231707,0.72687,0.979376},int(p*nModes+n) : rdtable;
modesT60s(i) = t60*pow(1-(modesFreqs(i)/3770.21)*t60DecayRatio,t60DecaySlope);
};
